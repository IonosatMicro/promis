---
- name:   ${conf.hostname_db}
  image:  "mdillon/postgis:9.6"
  ports:  [ "${conf.port_sql}" ]
  env:
    POSTGRES_USER:      ${conf.postgres_user}
    POSTGRES_PASSWORD:  ${conf.postgres_password}
    POSTGRES_DB:        ${conf.postgres_dbname}

- name:     ${conf.hostname_api}
  build:    ${conf.dir_api}
  git_repo: "github.com/${conf.repo_api}#${conf.version_api}" # requires #17
  depend:   [ "${conf.hostname_db}" ]
  sync:
    - [ "sync/", "${conf.sync_api_dir}" ]
  env:
    POSTGRES_USER:      ${conf.postgres_user}
    POSTGRES_PASSWORD:  ${conf.postgres_password}
    POSTGRES_DB:        ${conf.postgres_dbname}
    POSTGRES_HOST:      ${conf.hostname_db}
    POSTGRES_PORT:      ${conf.port_sql}
    SYNC_DIR:           ${conf.sync_api_dir}
    PYTHONUNBUFFERED:   "0"

- name:   ${conf.hostname_web}
  build:  ${conf.dir_web}
  git_repo: "github.com/${conf.repo_web}#${conf.version_web}" # requires #17
  ports:  [ "${conf.port_api}", "${conf.port_web}" ]
  sync:
    - [ "nginx/", "/etc/nginx/conf.d/" ]
    - [ "ssl/", "${conf.ssl_prefix}"]
    - [ "sync/", "${conf.sync_web_dir}" ]
  depend: [ "${conf.hostname_api}" ]
  env:
    SERVERNAME_WEB:     ${conf.servername_web}
    SERVERNAME_API:     ${conf.servername_api}
    HOSTNAME_API:       ${conf.hostname_api}
    PORT_WEB:           ${conf.port_web}
    PORT_API:           ${conf.port_api}
    PORT_API_INTERNAL:  ${conf.port_api_internal}
    API_URL:            ${conf.api_url}
    PORT_KEY_WEB:       ${conf.port_key_web}
    PORT_KEY_API:       ${conf.port_key_api}
    SYNC_PATH:          ${conf.sync_web_path}
