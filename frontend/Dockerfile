FROM richarvey/nginx-nodejs

# TODO: consider the alternative of just
# using alpine nginx and installing nodejs over

# Do this first to benefit from cache
RUN mkdir -p /usr/src/promis/app
WORKDIR /usr/src/promis
ADD package.json /usr/src/promis/
# Allegedly speeds up things. TODO: verify
RUN npm config set registry https://registry.npmjs.org/
RUN npm install 
ADD webpack.config.js /usr/src/promis/

# This doesn't contain any replacements
ADD nginx.conf /etc/nginx/

# Configs generated by deploy
ADD deploy/promis.conf /etc/nginx/
ADD deploy/promis_api.yaml /var/www/promis/api/

# TODO
#RUN chgrp nginx /etc/ssl/private
#RUN chmod g+x,g+r /etc/ssl/private

# Add the actual app
ADD run_web_promis.sh /
ADD app /usr/src/promis/app/
# TODO: please remove what's no longer applicable!
ADD css /usr/src/promis/css/
ADD js /usr/src/promis/js/
ADD fonts /usr/src/promis/fonts/

# The original image uses supervisord to start up
# Skipping their logic and just running our stuff
CMD [ "/run_web_promis.sh" ]
