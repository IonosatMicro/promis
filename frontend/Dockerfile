FROM smebberson/alpine-nginx-nodejs

# Stream the nginx logs to stdout and stderr
# Stolen from the author's Dockerfile :)
RUN ln -sf /dev/stdout /var/log/nginx/access.log && \
    ln -sf /dev/stderr /var/log/nginx/error.log

# Do this first to benefit from cache
RUN mkdir -p /usr/src/promis/app
WORKDIR /usr/src/promis
ADD package.json /usr/src/promis/

# Install packages needed
RUN npm install
ADD webpack.config.js /usr/src/promis/

# This doesn't contain any replacements
ADD nginx.conf /etc/nginx/

# Configs generated by deploy
ADD deploy/promis.conf /etc/nginx/
ADD deploy/promis_api.yaml /var/www/promis/api/

# TODO
#RUN chgrp nginx /etc/ssl/private
#RUN chmod g+x,g+r /etc/ssl/private

# Add the actual app
ADD run_web_promis.sh /
ADD app /usr/src/promis/app/

# The original image uses supervisord to start up
# Skipping their logic and just running our stuff
CMD [ "/run_web_promis.sh" ]
